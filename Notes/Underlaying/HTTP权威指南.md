<!-- START doctoc generated TOC please keep comment here to allow auto update -->
<!-- DON'T EDIT THIS SECTION, INSTEAD RE-RUN doctoc TO UPDATE -->
**Table of Contents**  *generated with [DocToc](https://github.com/thlorenz/doctoc)*

- [HTTP 权威指南](#http-%E6%9D%83%E5%A8%81%E6%8C%87%E5%8D%97)
  - [概述](#%E6%A6%82%E8%BF%B0)
    - [网络连接](#%E7%BD%91%E7%BB%9C%E8%BF%9E%E6%8E%A5)
    - [Web 的结构组件](#web-%E7%9A%84%E7%BB%93%E6%9E%84%E7%BB%84%E4%BB%B6)
  - [URL 与资源](#url-%E4%B8%8E%E8%B5%84%E6%BA%90)
  - [HTTP 报文](#http-%E6%8A%A5%E6%96%87)
  - [网络连接](#%E7%BD%91%E7%BB%9C%E8%BF%9E%E6%8E%A5-1)
    - [TCP](#tcp)
    - [TCP 的连接](#tcp-%E7%9A%84%E8%BF%9E%E6%8E%A5)
      - [三次握手](#%E4%B8%89%E6%AC%A1%E6%8F%A1%E6%89%8B)
      - [Nagle 算法](#nagle-%E7%AE%97%E6%B3%95)
      - [`TIME_WAIT`累积和端口耗尽](#time_wait%E7%B4%AF%E7%A7%AF%E5%92%8C%E7%AB%AF%E5%8F%A3%E8%80%97%E5%B0%BD)
      - [TCP 连接关闭](#tcp-%E8%BF%9E%E6%8E%A5%E5%85%B3%E9%97%AD)
  - [代理](#%E4%BB%A3%E7%90%86)
    - [使用代理过程中可能遇见的问题](#%E4%BD%BF%E7%94%A8%E4%BB%A3%E7%90%86%E8%BF%87%E7%A8%8B%E4%B8%AD%E5%8F%AF%E8%83%BD%E9%81%87%E8%A7%81%E7%9A%84%E9%97%AE%E9%A2%98)
  - [网关](#%E7%BD%91%E5%85%B3)
    - [资源网关](#%E8%B5%84%E6%BA%90%E7%BD%91%E5%85%B3)
  - [认证](#%E8%AE%A4%E8%AF%81)
    - [基本认证](#%E5%9F%BA%E6%9C%AC%E8%AE%A4%E8%AF%81)
    - [摘要认证](#%E6%91%98%E8%A6%81%E8%AE%A4%E8%AF%81)
    - [对称加密](#%E5%AF%B9%E7%A7%B0%E5%8A%A0%E5%AF%86)
    - [公开密钥加密（非对称加密）](#%E5%85%AC%E5%BC%80%E5%AF%86%E9%92%A5%E5%8A%A0%E5%AF%86%E9%9D%9E%E5%AF%B9%E7%A7%B0%E5%8A%A0%E5%AF%86)
    - [混合加密](#%E6%B7%B7%E5%90%88%E5%8A%A0%E5%AF%86)
    - [数字签名](#%E6%95%B0%E5%AD%97%E7%AD%BE%E5%90%8D)
    - [数字证书](#%E6%95%B0%E5%AD%97%E8%AF%81%E4%B9%A6)
    - [HTTPS](#https)

<!-- END doctoc generated TOC please keep comment here to allow auto update -->

## HTTP 权威指南

HTTP 权威指南不完全笔记

### 概述

- URI：统一资源标识符
- URL：统一资源定位符。是 URI 的常见表现形式
- URN：统一资源名，与位置无关的资源。是 URI 的另一种形式

- 幂等性：同一个事务，不管执行多少次，得到的结果都相同

#### 网络连接

HTTP 请求是应用层协议，它把联网的细节都交给了网络传输协议 TCP/IP。从底层到上层的协议栈如下：

1. 物理网络硬件（物理层）
2. 网络特有的链路接口（数据链路层）
3. IP（网络层）
4. TCP/UDP（传输层）
5. HTTP（应用层）

#### Web 的结构组件

- 代理

代理位于客户端和服务器之间，用于接收 HTTP 请求，（可能对请求进行修改）然后进行转发

- 网关

也是一个中间实体，通常用于将 HTTP 流量转换为其他的协议

- 隧道

通过隧道，可以在两条连接之间对原始数据进行盲转发。常见应用是 HTTPS

- User-Agent

用户代理代表用户发起 HTTP 请求的客户端程序

### URL 与资源

URL 的通用表示：

`<scheme>://<user>:<password>@<host>:<port>/<path>;<params>?<query>#<frag>`

- `scheme`：方案，访问资源的形式。常见的有`http`, `https`, `mailto`, `ftp` 等
- `host`：主机，资源宿主服务器的主机名或者 IP 地址
- `path`：路径，服务器上路径的本地名
- `frag`：片段。URL 支持使用片段组件来表示一个资源内部的片段。但服务器通常只处理整个对象，因此需要由客户端来决定根据片段展现的资源

### HTTP 报文

HTTP 报文的三个部分：起始行、首部、主体；分成两大类：请求报文和相应报文。

请求报文的格式：

```bash
<method> <request-URL> <version>
<headers>
<entity-body>
```

相应报文的格式：

```bash
<version> <status> <reason-phrase>
<headers>
<entity-body>
```

- version: 请求所使用的 HTTP 版本。格式为`HTTP/<major>.<minor>`
- reason-phrase: 原因短语
- entity-body: 主体部分
- status: 状态码

状态码分类：

1. 100~199：信息提示
2. 200~299：成功
3. 300~399：重定向
4. 400~499：客户端错误
5. 500~599：服务器错误

常见状态码说明：

- `100 - Continue`服务器已收到请求的初始部分，客户端可以继续。一般用于客户端避免向服务器发送一个无法处理或大实体时，首先进行确认
- `201 - Created`相应用于创建服务器对象的请求
- `202 - Accepted`请求已被接受，但不保证已经完成
- `301 - Moved Permanently`代表资源已经被永久移除
- `303 - See Other`/`307 - Temporary Redirect`代表临时重定向
- `400 - Bad Request`客户端发送了错误的请求
- `401 - Unauthorized`客户端需要权限认证
- `403 - Forbidden`客户端的请求被服务端拒绝
- `405 - Method Not Allowed`客户端发起请求的方法不被服务器支持
- `408 - Request Timeout`客户端完成请求所花的时间太长，导致请求超时
- `500 - Internal Server Error`服务器错误
- `502 - Bad  Gateway`网关错误
- `503 - Service Unavailable`服务器目前无法提供服务
- `504 - Gateway Timeout`网关超时

### 网络连接

#### TCP

在 HTTP 请求的时候，首先要建立 TCP 连接，来为 HTTP 提供可靠的比特传输通道。TCP 的数据是通过名为 IP 分组（或 IP 数据报）的小数据块来发送的。而 HTTPS 就是在 HTTP 和 TCP 之间插入了密码加密层。

每一个 TCP 段都是由 IP 分组承载，从一个 IP 地址发送到另一个 IP 地址。每个 IP 分组中包括：

- 一个 IP 分组首部
- 一个 TCP 段首部：包含源 IP、目的 IP、长度等
- 一个 TCP 数据块：包含 TCP 端口号、TCP 控制标记

TCP 连接是通过如下 4 个值来进行识别的：

`<源 IP 地址、源端口号、目的 IP 地址、目的端口号>`

4 个值一起唯一地定义了一条连接。两条不同的 TCP 连接不能拥有 4 个完全相同的地址组件。

#### TCP 的连接

##### 三次握手

在创建连接时，需要经过下面三次握手：

1. 客户端向服务器发送一个小的 TCP 分组，在分组中设置了特殊的 SYN 标记，说明是一个连接的请求
2. 如果服务器接受了连接，则向客户端回送一个 TCP 分组，该分组内 SYN 和 ACK 标记都被置位，说明请求已经被接受
3. 最后，客户端向服务器回送一条确认消息

每个 TCP 段都有一个序列号和数据完整性校验。每个段的接收者在收到完好的段时，都会向发送者回送小的确认分组。如果发送者没有在指定的窗口时间内收到确认信息，则发送者会认为分组已被损坏，并重新发送数据。

##### Nagle 算法

TCP 有一个数据流接口，应用程序可以通过它将任意尺寸的数据放入 TCP 栈中。但如果 TCP 发送了大量包含少量数据的分组，则会严重影响网络性能。而 Nagle 算法会试图在发送一个分组之前，将大量 TCP 数据绑定在一起，以提高网络效率。

Nagle 算法原理：

1. 鼓励发送全尺寸的段。只有当其他所有分组都被确认之后，才允许发送非全尺寸的段
2. 如果其他分组仍在传输过程中，则会将数据缓存起来。只有当挂起分组被确认，或者缓存中积累了足够发送的全尺寸数据时，才会发出缓存的数据

Nagle 算法缺陷：

1. 小的 HTTP 报文可能无法填满一个分组，因此需要等待其他数据，产生延迟
2. 缓存阻碍数据的发送，知道有确认分组抵达为止

##### `TIME_WAIT`累积和端口耗尽

`TIME_WAIT`累积：

当某个 TCP 端口关闭连接时，会在内存中维护一个小的控制块，用于记录最近所关闭的 IP 地址和端口号。这类信息大概会维持 2 分钟（俗称 2MSL，为最大分段使用期的 2 倍），以确保在这段时间内不会创建相同地址和端口的新连接。

当并发数很高时，或者短时间内请求数很大，由于源端口数有限，且`TIME_WAIT`累积，则可能造成端口的耗尽问题。

##### TCP 连接关闭

- 半关闭：关闭 TCP 输入、输出通道中的一个
- 完全关闭：TCP 输入、输出通道都关闭

关闭连接的输出通道总是很安全。这样连接的另一端在读取了所有已输出的数据后，会收到一条流结束的通知，从而得知连接关闭。
而关闭连接的输入通道则比较危险。如果连接的另一端向已经关闭的输入通道发送数据，则接受到数据的操作系统会向发送方发出一条“TCP 连接被对端重置”的报文，造成发送方删除其还未读取的所有缓存数据。

正常关闭的应用程序应首先关闭其自身的输出信道，然后等待连接的另一端关闭它的输出信道，两者相互之间不再发送数据，就不会有重置的危险。

### 代理

- 代理和网关的对比：

代理连接的是两个或多个使用相同协议的程序；而网关则是作为“协议转换器”，连接的是使用不同协议的程序。

- 反向代理（Reverse Proxy）：

是指用代理服务器来接受网上的连接请求，然后将请求转发给内部网络上的服务器，并将从服务器上得到的结果返回给请求连接的客户端，此时代理服务器对外就表现为一个反向代理服务器。

#### 使用代理过程中可能遇见的问题

1. 请求信息的完整性：

当客户端向 Web 服务器发送请求时，客户端会直接与单个服务器进行对话，因此，主机名、端口等信息都是已知的，客户端只需发送部分 URI 即可；而当使用虚拟主机或者隐式代理时，客户端可能还是不会发送完整的 URI。此时客户端应该提供 Host 首部，来承载主机和端口信息。对于代理而言：

- 如果客户端提供了完整 URI，则使用完整 URI 进行转发
- 如果客户端提供了部分 URI 和 Host 首部，则通过 Host 首部来确认原始服务器和端口
- 如果客户端只提供了原始 URI，则
  - 如果代理是代表原始服务器的替代物，则使用真实服务器的地址和端口对代理进行预先配置
  - 如果流量被拦截了，则使用拦截者提供的原始 IP 和端口
  - 所有方法都失败，则返回错误报文

2. URI 自动扩展和主机名解析

根据是否有代理，浏览器对请求 URI 的解析会有所不同。

- 没有代理时，浏览器会获取输入的 URI，然后尝试获取对应的 IP 地址。如果没有找到，则进一步对输入进行扩展，例如，加入前缀`www.`和后缀`.com`，不断解析知道找到有效的主机名（或者失败）
- 有显式代理时，浏览器不会对不完整的主机名进行扩展，而是交给显式代理去做
- 有拦截代理/隐式代理时，因为浏览器感知不到代理的存在，所以会自行进行解析，利用解析得到的主机 IP 地址向代理进行请求。此时对于客户端而言，请求成功，不会再尝试其他解析。但实际的 IP 地址可能已经过期，因此，从代理到服务器的请求过程将会失败。所以，该代理本身必须具备和浏览器相同级别的容错机制，可以通过解析 Host 首部的主机名，或者对 IP 地址的反向 DNS 查询来尝试其他 IP

### 网关

网关的出现缘由：单个应用程序无法处理所有可能需要的资源。因此，网关作为某种翻译器使用，抽象出了一种能够到达资源的方法。网关是资源和应用程序之间的粘合剂。

Web 网关在一侧使用 HTTP 协议，另一次使用其他协议。通常可以描述为：`<客户端协议>/<服务端协议>`

- 客户端网关

网关通过其他协议与客户端对话，而通过 HTTP 协议和服务端通信。

- 服务端网关

网关通过 HTTP 协议与客户端对话，而通过其他协议和服务端通信。

#### 资源网关

网关与客户端通过 HTTP 进行通讯，并与服务端的应用程序通过网关应用编程接口（Application Programming Interface, API）相连。

通用网关接口（Common Gateway Interface, CGI）。CGI 是一个标准借口集，Web 服务器可以用它来装载程序以响应对特定 URL 的 HTTP 请求，并收集程序的输出数据，将其放在 HTTP 响应中回送。

### 认证

网络攻击方式：

- 重放攻击：攻击者将从某事务中窃取的认证证书，用于另一个事务
- 词典攻击：密码猜测型攻击方式
- 恶意代理攻击和中间人攻击
- 选择明文攻击：在摘要认证的时候篡改随机数
- [中间人攻击](https://zh.wikipedia.org/wiki/%E4%B8%AD%E9%97%B4%E4%BA%BA%E6%94%BB%E5%87%BB)

需要解决的认证问题：

- 服务器认证（客户端可以信任服务器）
- 客户端认证（服务器可以信任客户端）
- 完整性（数据不会被篡改）
- 加密
- 效率
- 普适性（几乎所有的客户端和服务器都能支持）
- 管理的可扩展性
- 实际可行性

#### 基本认证

1. 客户端请求资源
2. 服务端返回 401，初始化认证质询
3. 客户端返回用户名和密码，用 base64 形式编码
4. 服务端解码验证

基本认证缺点：

- 不安全，密码可以被捕获

#### 摘要认证

和基本认证相比，摘要认证不发送密码，而是发送一段密码的摘要。服务端收到摘要之后进行匹配。除此以外，摘要应该是使用随机数来进行加密的，且由于一定的过期时间，以防止摘要被人盗用。

1. 服务端在质询的时候，传入一个随机数和支持的算法
2. 客户端选择一个算法，用随机数对摘要加密，传递给服务端。如果客户端需要对服务端进行验证，可以发送客户端随机数。
3. 服务端根据算法和数据，也计算出一段摘要，和客户端传入的摘要进行比较。如果收到了客户端的质询（随机数），则需要生产服务端摘要后再传递给客户端。

摘要认证的预授权问题：

- 预先生成下一个随机数：破坏了管道化，会造成延迟
- 重用随机数：更容易被重放攻击
- 同步生成随机数：较复杂

避免重放攻击的方法：

为每一个事务都使用一个唯一的随机数（和一个超时值）。发布的随机数只对指定的事务有效，且只在超时值的持续区间内有效。

#### 对称加密

编码、解码时使用的密钥一样。攻击者在没有密钥的情况下，可以会进行暴力枚举，去尝试每一种可能的密钥来破解密文。密钥长度越长，则可能的密钥数量越大，破解需要的时间和资源也就越多。

对称加密的缺点：发送者和接收者在互相对话之前，需要有一个共享的密钥。服务器需要为每一个不同的客户端创建密钥，会使密钥越来越多。

#### 公开密钥加密（非对称加密）

编码密钥是公开的，即公钥。服务器用有公钥和私钥，对于每一个请求的客户端，都使用同样的公钥，而只有有私钥的人才能进行解码。

#### 混合加密

先利用非对称加密来建立安全的通讯，然后再通过更快的对称加密对其余的数据进行加密

#### 数字签名

签名通常是非对称加密实现的，只要密钥不泄露，就可以防止报文被篡改。在数据传输过程中，对利用私钥和部分数据摘要进行签名，数据接收方再进行验证，以保证数据的可靠性。解密过程即签名过程的反函数。

数字签名过程：

1. 节点 A 将变长报文提取为定长的摘要
2. 节点 A 对摘要应用一个签名函数，该函数以私钥和摘要为参数，生成一段签名
3. 节点 A 将签名、报文、摘要发送给节点 B
4. 在接收端，节点 B 对签名进行检查：对收到的签名，使用公开密钥的反函数。如果得到的摘要和节点 A 发送的摘要不一致，则可以认为报文被篡改。

#### 数字证书

基本的数字证书 `certs` 包含：

- 对象名称（人、组织、服务器等）
- 过期时间
- 证书颁发者
- 来自颁发者的数字签名

在通过 HTTPS 建立了一个安全 Web 事务之后，现代的浏览器都会自动获取所连接服务器的数字证书。证书内包括站点的名称、主机名、站点公开密钥、颁发机构、颁发机构的签名。

#### HTTPS

- HTTP 在默认情况下会连接到服务器的 80 端口
- HTTPS 在默认情况下会连接到服务器的 443 端口

在连接到 443 端口之后，客户端和服务端要进行 TLS 握手，在握手过程中：

- 交换协议版本号
- 交换加密方式
- 对两端身份进行验证
- 生成临时的会话密钥，用于加密信道

检验站点证书的有效性：

- 证书有效期检测
- 签名颁发者可信度检测
- 签名检测
- 站点身份检测（证书和域名的对照）

